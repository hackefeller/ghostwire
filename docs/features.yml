version: 1
source: agents/features.yml
description: Map of feature directories under src/execution/features and src/orchestration/features with detailed descriptions.

features:
  # === Core Execution Features ===

  - id: background-agent
    path: src/execution/features/background-agent
    description: |
      Manages long-running background tasks with concurrency control and session tracking.
      The BackgroundManager class handles launching, resuming, and monitoring background tasks.
      Provides concurrency management to limit simultaneous tasks.
      Tracks task status: pending, running, completed, error.
      Manages task queues per concurrency key.
      Integrates with tmux for subagent session management.
      Tracks parent-child relationships between tasks.
      Handles stale task detection and provides completion/error notifications.
      Includes TTL (time-to-live) management and stability detection.

  - id: task-queue
    path: src/execution/features/task-queue
    description: |
      Provides persistent task queue storage with dependency management.
      Defines task types: id, subject, description, activeForm, owner, status, blocks, blockedBy, metadata.
      Status values: pending, in_progress, completed.
      Provides storage utilities for file-based persistence with Claude Code compatibility mode.
      Supports team directories for swarm coordination and multiple task lists.
      Task dependencies enable sophisticated workflow management.

  - id: agent-swarm
    path: src/execution/features/agent-swarm
    description: |
      Provides inter-agent communication primitives for multi-agent coordination.
      The mailbox subdirectory defines message types for agent swarm communication.
      MailboxMessage: Basic messages with sender, text, timestamp, color, read status.
      PermissionRequest/Response: Tool permission elevation between agents.
      TaskAssignment/Completed: Distribute work across agents.
      JoinRequest/Approved/Rejected: Agent team membership.
      PlanApprovalRequest/Response: Collaborative planning.
      ModeSetRequest: Change agent operating modes.
      TeamPermissionUpdate: Share permission configs across team members.

  # === Built-in Components ===

  - id: builtin-commands
    path: src/execution/features/builtin-commands
    description: |
      Provides built-in slash commands that wrap prompt templates for common development workflows.
      Defines 34+ built-in commands organized by category:
      - Initialization: init-deep
      - Loops: ultrawork-loop, ulw-ultrawork, cancel-ultrawork
      - Refactoring: refactor, ghostwire:code:*
      - Git operations: ghostwire:git:*
      - Project management: ghostwire:project:*
      - Utilities: ghostwire:util:*
      - Documentation: ghostwire:docs:*
      Each command wraps a prompt template with specialized AI instructions.
      Includes argument hints for user guidance.
      Can be selectively disabled via configuration.

  - id: builtin-skills
    path: src/execution/features/builtin-skills
    description: |
      Provides pre-configured skills with MCP server integrations for common tasks.
      Exports built-in skills with domain-specific instructions:
      - Playwright: Browser automation via @playwright/mcp
      - agent-browser: Vercel's agent-browser CLI
      Each skill defines: name, description, instruction template, allowed tools, MCP server config.
      Designed to work with skill loader and MCP manager features.

  - id: ultrawork-state
    path: src/execution/features/ultrawork-state
    description: |
      Tracks active work plan state from ultrawork.json for the Cipher Operator orchestrator.
      Manages reading and writing ultrawork.json file.
      Tracks: active plan file path, start timestamp, session IDs that worked on plan, plan name.
      Provides utilities to find planner plan files in .ghostwire/plans directory.
      Enables persistence of multi-session planning workflows.

  # === Claude Code Compatibility ===

  - id: claude-code-agent-loader
    path: src/execution/features/claude-code-agent-loader
    description: |
      Loads Claude Code agent definitions from markdown files in config directories.
      Reads agent definitions from CLAUDE_DIR/agents/*.md.
      Parses frontmatter for agent metadata (name, description, tools).
      Loads agent prompts from file body.
      Supports user-level (~/.config/claude/agents/) and project-level (.claude/agents/).

  - id: claude-code-command-loader
    path: src/execution/features/claude-code-command-loader
    description: |
      Loads Claude Code command definitions from markdown files with frontmatter parsing.
      Recursively scans command directories for markdown files.
      Supports hierarchical command namespacing via subdirectories (e.g., git:commit).
      Parses frontmatter for command metadata (description, argument hints).
      Wraps markdown body in standard template with command-instruction and user-request tags.
      Loads from multiple scopes: user, project, builtin.

  - id: claude-code-mcp-loader
    path: src/execution/features/claude-code-mcp-loader
    description: |
      Loads and transforms Claude Code .mcp.json configurations to OpenCode format.
      Reads MCP configurations from multiple scopes:
      - User: ~/.config/claude/.mcp.json
      - Project: .mcp.json
      - Local: .claude/.mcp.json
      Transforms configuration format to OpenCode's internal format.
      Supports environment variable expansion in configuration values.
      Provides getSystemMcpServerNames() to enumerate available servers.

  - id: claude-code-plugin-loader
    path: src/execution/features/claude-code-plugin-loader
    description: |
      Loads and parses Claude Code plugin configurations.
      Provides utilities for loading plugin configurations.
      Exports types for plugin loader options and Claude settings.
      Enables interoperability with Claude Code's plugin system.

  - id: claude-code-session-state
    path: src/execution/features/claude-code-session-state
    description: |
      Manages session tracking for main and subagent sessions.
      Provides in-memory state management:
      - setMainSession/getMainSessionID: Track main session ID
      - subagentSessions: Maintain set of active subagent sessions
      - setSessionAgent/getSessionAgent: Session-to-agent mapping
      Used by background-agent and tmux-subagent to track running sessions.
      Includes _resetForTesting() for test isolation.

  # === Context & Injection ===

  - id: context-injector
    path: src/execution/features/context-injector
    description: |
      Collects and injects contextual information into agent messages with priority ordering.
      ContextCollector class registers context entries per session.
      Priority levels: critical, high, normal, low.
      Context entries keyed by source and ID to avoid duplicates.
      getPending(): Retrieve merged context sorted by priority.
      consume(): Get and clear context.
      hasPending(): Check for pending context.
      Creates hook that injects collected context into message outputs.

  - id: hook-message-injector
    path: src/execution/features/hook-message-injector
    description: |
      Stores and retrieves hook messages for cross-session context sharing.
      injectHookMessage(): Store messages.
      findNearestMessageWithField(): Find messages with specific field values.
      findFirstMessageWithAgent(): Locate messages by agent type.
      Provides MESSAGE_STORAGE constant for message storage access.
      Used for passing context between orchestration hooks.

  # === MCP & OAuth ===

  - id: mcp-oauth
    path: src/execution/features/mcp-oauth
    description: |
      Implements OAuth 2.0 authentication for MCP server connections.
      Features:
      - OAuth schema validation (McpOauthSchema)
      - Provider class for OAuth flows with authorization code and refresh tokens
      - Dynamic Client Registration (DCR) for automatic credentials
      - OAuth server metadata discovery
      - Resource indicator support
      - Step-up authentication for elevated privileges
      - Token storage with encryption
      - Callback server for handling OAuth redirects
      Implements PKCE for secure authentication flows.

  - id: skill-mcp-manager
    path: src/execution/features/skill-mcp-manager
    description: |
      Manages MCP server connections for skills with OAuth and lifecycle handling.
      SkillMcpManager provides MCP server lifecycle management:
      - Client connection management with caching
      - Support for stdio and HTTP transport types
      - OAuth provider integration for authenticated servers
      - Automatic reconnection handling
      - Environment variable expansion in configs
      - Idle timeout with automatic cleanup (5 min default)
      - Pending connection queue to prevent duplicates

  - id: opencode-skill-loader
    path: src/execution/features/opencode-skill-loader
    description: |
      Loads and manages OpenCode skills with async discovery and blocking behavior.
      Provides:
      - Loader class for discovering skills from directories
      - AsyncLoader for non-blocking skill discovery
      - SkillContent for parsing skill markdown files
      - Merger for combining multiple skill definitions
      - Blocking behavior detection
      Supports skill metadata parsing from YAML frontmatter.
      Provides caching and parallel processing for discovery.

  # === Utilities ===

  - id: task-toast-manager
    path: src/execution/features/task-toast-manager
    description: |
      Tracks task status and displays toast notifications for background tasks.
      Features:
      - TrackedTask interface: id, description, agent, status, start time, category, skills, modelInfo
      - TaskStatus types: running, queued, completed, error
      - ModelFallbackInfo for tracking model usage (user-defined, inherited, category-default, system-default)
      - TaskToastOptions for notification configuration
      Used by background tasks to report status and provide user feedback.

  - id: tmux-subagent
    path: src/execution/features/tmux-subagent
    description: |
      Manages tmux panes for running subagent sessions with state-first architecture.
      Implements QUERY-DECIDE-EXECUTE-UPDATE architecture:
      - PaneStateQuerier: Queries actual tmux pane state as source of truthEngine: Determines spawn/close actions based
      - Decision on state
      - ActionExecutor: Executes actions with verification
      - Manager: Maintains internal cache only after tmux confirms
      Features: capacity configuration, session tracking, window state queries, pending session management, polling for background session status.
      Requires tmux to be enabled and running inside tmux.

  - id: imports
    path: src/execution/features/imports
    description: |
      Provides utilities for importing and converting Claude Code configurations.
      The imports/claude subdirectory provides:
      - mapper.ts: importClaudePluginFromPath() to convert plugin format
      - hook-translator.ts: Translate between Claude Code hooks and OpenCode hooks
      - Schema validation
      - Security checks
      - Telemetry
      - Diagnostics
      Supports importing agents, commands, and plugin components.

notes:
  - Keep this file in sync with src/execution/features directory changes.
  - Features organized by category: Core Execution, Built-in Components, Claude Code Compatibility, Context & Injection, MCP & OAuth, Utilities.
